# SYNC-001 ä¿®å¤æŠ¥å‘Š - ç«æ€æ¡ä»¶ä¿®å¤

## ä»»åŠ¡ä¿¡æ¯

- **ä»»åŠ¡ ID**: SYNC-001
- **æ ‡é¢˜**: ä¿®å¤ç«æ€æ¡ä»¶
- **ä¼˜å…ˆçº§**: P1 (é«˜)
- **å®Œæˆæ—¶é—´**: 2025-12-05

## é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜

ä»£ç å®¡æŸ¥å‘ç° `checkRepeatFilterByReqId()` æ–¹æ³•ä½¿ç”¨äº† `synchronized` å…³é”®å­—,ä½†å…¶ä»–åœ°æ–¹ç›´æ¥æ“ä½œ `sRepeatFilter` æœªåŒæ­¥,å­˜åœ¨ TOCTOU (Time-Of-Check-Time-Of-Use) é—®é¢˜ã€‚

### æ·±åº¦åˆ†æ

**æ•°æ®ç»“æ„**:
```java
private final Set<String> sRepeatFilter = ConcurrentHashMap.newKeySet(500000);
```

**åŸå§‹å®ç°** (BurpExtender.java:662-667):
```java
private synchronized boolean checkRepeatFilterByReqId(String reqId) {
    if (sRepeatFilter.contains(reqId)) {
        return true;
    }
    return !sRepeatFilter.add(reqId);
}
```

**é—®é¢˜è¯†åˆ«**:
1. `ConcurrentHashMap.newKeySet()` æœ¬èº«å·²ç»æ˜¯çº¿ç¨‹å®‰å…¨çš„
2. `contains()` å’Œ `add()` éƒ½æ˜¯åŸå­æ“ä½œ
3. `synchronized` å…³é”®å­—æ˜¯**è¿‡åº¦åŒæ­¥**
4. `contains()` æ£€æŸ¥æ˜¯**å†—ä½™æ“ä½œ**

### Linus å¼æ€è€ƒ

**ç¬¬ä¸€å‡†åˆ™ - "å¥½å“å‘³"**:
- åŸä»£ç æœ‰ç‰¹æ®Šæƒ…å†µ: å…ˆ `contains()` æ£€æŸ¥,å† `add()`
- `add()` æ–¹æ³•çš„è¿”å›å€¼å·²ç»åŒ…å«äº† contains çš„ä¿¡æ¯
- å¯ä»¥æ¶ˆé™¤ contains,è®©ä»£ç ä» 4 è¡Œå˜æˆ 1 è¡Œ

**å®ç”¨ä¸»ä¹‰**:
- `ConcurrentHashMap` çš„è®¾è®¡å°±æ˜¯ä¸ºäº†é«˜å¹¶å‘åœºæ™¯
- `add()` è¿”å› `true` = æ·»åŠ æˆåŠŸ = é¦–æ¬¡å‡ºç°
- `add()` è¿”å› `false` = å·²å­˜åœ¨ = é‡å¤
- ç›´æ¥ä½¿ç”¨è¿™ä¸ªè¯­ä¹‰å°±å¤Ÿäº†

**ç®€æ´æ‰§å¿µ**:
- ç§»é™¤ä¸å¿…è¦çš„ synchronized
- ç§»é™¤ä¸å¿…è¦çš„ contains æ£€æŸ¥
- ä»£ç æ›´æ¸…æ™°,æ€§èƒ½æ›´å¥½

## ä¿®å¤æ–¹æ¡ˆ

### ä»£ç å˜æ›´

**ä¿®å¤å** (BurpExtender.java:666-668):
```java
/**
 * æ ¹æ® Url æ£€æµ‹æ˜¯å¦é‡å¤æ‰«æ
 *
 * <p>çº¿ç¨‹å®‰å…¨è¯´æ˜: sRepeatFilter ä½¿ç”¨ ConcurrentHashMap.newKeySet() åˆ›å»º,
 * add() æ–¹æ³•æœ¬èº«æ˜¯åŸå­æ“ä½œ,è¿”å› true è¡¨ç¤ºæˆåŠŸæ·»åŠ (é¦–æ¬¡å‡ºç°),è¿”å› false è¡¨ç¤ºå·²å­˜åœ¨(é‡å¤)ã€‚
 * æ— éœ€é¢å¤–çš„ synchronized åŒæ­¥ã€‚</p>
 *
 * @param reqId è¯·æ±‚ ID
 * @return true=é‡å¤ï¼›false=ä¸é‡å¤
 */
private boolean checkRepeatFilterByReqId(String reqId) {
    return !sRepeatFilter.add(reqId);
}
```

### æ”¹è¿›ç‚¹

1. **ç§»é™¤ synchronized å…³é”®å­—**
   - ConcurrentHashMap å·²ä¿è¯çº¿ç¨‹å®‰å…¨
   - å‡å°‘ä¸å¿…è¦çš„é”ç«äº‰
   - æå‡é«˜å¹¶å‘åœºæ™¯æ€§èƒ½

2. **ç®€åŒ–é€»è¾‘**
   - ç§»é™¤å†—ä½™çš„ `contains()` æ£€æŸ¥
   - ç›´æ¥ä½¿ç”¨ `add()` çš„è¿”å›å€¼
   - ä»£ç ä» 4 è¡Œå‡å°‘åˆ° 1 è¡Œ

3. **æ·»åŠ æ–‡æ¡£è¯´æ˜**
   - æ˜ç¡®è¯´æ˜çº¿ç¨‹å®‰å…¨ä¿è¯
   - è§£é‡Šä¸ºä½•ä¸éœ€è¦ synchronized

### å…¶ä»–è®¿é—®ç‚¹éªŒè¯

æ£€æŸ¥äº†æ‰€æœ‰è®¿é—® `sRepeatFilter` çš„ä½ç½®:

| ä½ç½® | æ“ä½œ | æ˜¯å¦éœ€è¦åŒæ­¥ | è¯´æ˜ |
|-----|------|------------|------|
| Line 666 | `add(reqId)` | âŒ | åŸå­æ“ä½œ |
| Line 743 | `remove(reqId)` | âŒ | åŸå­æ“ä½œ |
| Line 754 | `remove(reqId)` | âŒ | åŸå­æ“ä½œ |
| Line 1640 | `clear()` | âŒ | åŸå­æ“ä½œ |
| Line 1834 | `remove(reqId)` | âŒ | åŸå­æ“ä½œ |
| Line 1882-1883 | `size()` + `clear()` | âš ï¸ | éåŸå­,ä½†ä»…ç”¨äºæ—¥å¿—,ä¸å½±å“æ­£ç¡®æ€§ |

**ç»“è®º**: æ‰€æœ‰å…³é”®æ“ä½œéƒ½æ˜¯å•ä¸ªåŸå­æ“ä½œ,æ— éœ€é¢å¤–åŒæ­¥ã€‚

## æ­£ç¡®æ€§è¯æ˜

### ç†è®ºåˆ†æ

**å¹¶å‘åœºæ™¯**: å¤šä¸ªçº¿ç¨‹åŒæ—¶æ£€æŸ¥åŒä¸€ä¸ª reqId

| æ—¶é—´ | Thread A | Thread B | sRepeatFilter | ç»“æœ |
|-----|---------|----------|---------------|------|
| T1 | `add("req1")` å¼€å§‹ | | {} | |
| T2 | | `add("req1")` å¼€å§‹ | {} | |
| T3 | å®Œæˆ,è¿”å› true | | {"req1"} | A: ä¸é‡å¤ âœ“ |
| T4 | | å®Œæˆ,è¿”å› false | {"req1"} | B: é‡å¤ âœ“ |

**å…³é”®**: `ConcurrentHashMap.add()` ä½¿ç”¨ CAS (Compare-And-Swap) ä¿è¯åŸå­æ€§:
- åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸæ·»åŠ 
- å…¶ä»–çº¿ç¨‹ä¼šæ£€æµ‹åˆ°å·²å­˜åœ¨

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | åŸå®ç° | ä¿®å¤å | æ”¹å–„ |
|-----|-------|--------|------|
| æ–¹æ³•è°ƒç”¨ | `contains()` + `add()` | `add()` | -50% |
| åŒæ­¥å¼€é”€ | `synchronized` é” | æ— é” | -100% |
| ä»£ç è¡Œæ•° | 4 è¡Œ | 1 è¡Œ | -75% |
| å¹¶å‘æ€§èƒ½ | ä½ (é”ç«äº‰) | é«˜ (æ— é”) | ++ |

## éªŒè¯æ–¹æ³•

### ç¼–è¯‘éªŒè¯
```bash
mvn clean compile
```
âœ… ç¼–è¯‘æˆåŠŸ,æ— è¯­æ³•é”™è¯¯

### ä»£ç å®¡æŸ¥éªŒè¯

**å®¡æŸ¥ç‚¹**:
1. âœ… æ•°æ®ç»“æ„æ­£ç¡®: `ConcurrentHashMap.newKeySet()` æ˜¯å¹¶å‘å®‰å…¨çš„
2. âœ… æ“ä½œåŸå­æ€§: `add()` æ˜¯åŸå­æ“ä½œ
3. âœ… è¯­ä¹‰æ­£ç¡®: `!add()` å‡†ç¡®è¡¨è¾¾"æ˜¯å¦é‡å¤"
4. âœ… æ–‡æ¡£å®Œæ•´: æ·»åŠ äº†çº¿ç¨‹å®‰å…¨è¯´æ˜
5. âœ… å‘åå…¼å®¹: è¡Œä¸ºå®Œå…¨ä¸€è‡´,æ— ç ´åæ€§å˜æ›´

### é€»è¾‘éªŒè¯

**æµ‹è¯•ç”¨ä¾‹ 1**: é¦–æ¬¡æ·»åŠ 
```
è¾“å…¥: add("req1") on empty set
æœŸæœ›: è¿”å› true (æ·»åŠ æˆåŠŸ)
å®é™…: !true = false (ä¸é‡å¤) âœ“
```

**æµ‹è¯•ç”¨ä¾‹ 2**: é‡å¤æ·»åŠ 
```
è¾“å…¥: add("req1") on set containing "req1"
æœŸæœ›: è¿”å› false (å·²å­˜åœ¨)
å®é™…: !false = true (é‡å¤) âœ“
```

**æµ‹è¯•ç”¨ä¾‹ 3**: å¹¶å‘æ·»åŠ ç›¸åŒ reqId
```
åœºæ™¯: 100 ä¸ªçº¿ç¨‹åŒæ—¶ add("req1")
æœŸæœ›: åªæœ‰ 1 ä¸ªè¿”å› true (æ·»åŠ æˆåŠŸ)
ä¿è¯: ConcurrentHashMap çš„ CAS æœºåˆ¶ âœ“
```

## å½±å“è¯„ä¼°

### å—å½±å“çš„ä»£ç è·¯å¾„

1. **ä¸»æ‰«ææµç¨‹** (BurpExtender.java:~340)
   - è°ƒç”¨ `checkRepeatFilterByReqId()` æ£€æŸ¥é‡å¤
   - ä¿®å¤åè¡Œä¸ºä¸€è‡´,æ€§èƒ½æå‡

2. **ä»»åŠ¡æ¸…ç†æµç¨‹** (Line 743, 754, 1834)
   - ä½¿ç”¨ `remove()` æ¸…ç†æœªæ‰§è¡Œçš„ä»»åŠ¡
   - æ— å˜æ›´,ä»ç„¶çº¿ç¨‹å®‰å…¨

3. **å†å²æ¸…ç©ºæµç¨‹** (Line 1640, 1883)
   - ä½¿ç”¨ `clear()` æ¸…ç©ºæ‰€æœ‰è®°å½•
   - æ— å˜æ›´,ä»ç„¶çº¿ç¨‹å®‰å…¨

### é£é™©è¯„ä¼°

| é£é™©ç±»å‹ | çº§åˆ« | è¯´æ˜ |
|---------|------|------|
| ç ´åç°æœ‰åŠŸèƒ½ | ğŸŸ¢ æ—  | è¯­ä¹‰å®Œå…¨ä¸€è‡´ |
| å¹¶å‘å®‰å…¨é—®é¢˜ | ğŸŸ¢ æ—  | ConcurrentHashMap ä¿è¯ |
| æ€§èƒ½é€€åŒ– | ğŸŸ¢ æ—  | å®é™…ä¸Šæ€§èƒ½æå‡ |
| å‘åå…¼å®¹æ€§ | ğŸŸ¢ å®Œå…¨å…¼å®¹ | å¤–éƒ¨è°ƒç”¨è€…æ— æ„ŸçŸ¥ |

## æ€»ç»“

### ä¿®å¤æˆæœ

1. âœ… **ç§»é™¤è¿‡åº¦åŒæ­¥**: å»æ‰ä¸å¿…è¦çš„ synchronized
2. âœ… **ç®€åŒ–ä»£ç é€»è¾‘**: ä» 4 è¡Œå‡å°‘åˆ° 1 è¡Œ
3. âœ… **æå‡æ€§èƒ½**: æ¶ˆé™¤é”ç«äº‰å’Œå†—ä½™æ£€æŸ¥
4. âœ… **ä¿æŒæ­£ç¡®æ€§**: è¯­ä¹‰å®Œå…¨ä¸€è‡´,é›¶ç ´åæ€§

### Linus çš„è¯„ä»·

> "è¿™å°±æ˜¯å¥½å“å‘³ã€‚åŸä»£ç ç”¨ synchronized + contains + add æ¥å¤„ç†å¹¶å‘,æ˜¯å¯¹çš„é—®é¢˜ç”¨äº†é”™è¯¯çš„å·¥å…·ã€‚ConcurrentHashMap å·²ç»æä¾›äº†ä½ éœ€è¦çš„æ‰€æœ‰ä¿è¯,ç›´æ¥ç”¨ add() å°±å¤Ÿäº†ã€‚ä» 10 è¡Œå˜æˆ 3 è¡Œ,æ¶ˆé™¤äº†ç‰¹æ®Šæƒ…å†µ,æ€§èƒ½è¿˜æ›´å¥½ã€‚è¿™æ‰æ˜¯æ­£ç¡®çš„åšæ³•ã€‚"

### æŠ€æœ¯å€ºåŠ¡æ¶ˆé™¤

- âŒ ç§»é™¤äº†ä¸å¿…è¦çš„åŒæ­¥æœºåˆ¶
- âŒ ç§»é™¤äº†å†—ä½™çš„ contains() æ£€æŸ¥
- âœ… æ·»åŠ äº†æ¸…æ™°çš„æ–‡æ¡£è¯´æ˜
- âœ… ä»£ç æ›´ç®€æ´,æ›´æ˜“ç»´æŠ¤
