# STYLE-003 深度思考：拆分过长方法

## 任务本质

拆分三个过长方法以提升可读性和可维护性：
- `doScan()`: 88 行 → 目标 < 30 行
- `setupVariable()`: 76 行 → 目标 < 30 行
- `buildRequest()`: 65 行 → 目标 < 30 行

## Linus 的三个问题

1. **"这是个真问题还是臆想出来的？"**
   - ✅ 真问题。88 行的方法确实太长，影响可读性和维护性。

2. **"有更简单的方法吗？"**
   - 方法提取（Extract Method）已经是最简单的解决方案。

3. **"会破坏什么吗？"**
   - 重构操作如果保持行为不变就不会破坏功能，但需要谨慎验证。

## 数据结构分析

三个方法的核心数据：
- `doScan()`: 处理 HTTP 请求/响应、扫描规则、匹配结果
- `setupVariable()`: 处理变量替换、payload、参数映射
- `buildRequest()`: 构建 HTTP 请求的 headers 和 body

数据流：输入参数 → 中间处理 → 输出结果/副作用

## 复杂度审查

拆分原则：
- 一个方法只做一件事
- 方法名清晰表达职责
- 参数不超过 3-4 个
- 避免超过 3 层缩进

目标结构：
- 主方法 ~20 行（协调流程）
- 辅助方法各 15-20 行（具体职责）

## 破坏性风险

风险点：
1. 执行顺序改变
2. 变量作用域改变
3. 异常处理逻辑中断
4. 副作用时机变化

降低风险策略：
- 仅提取方法，不改逻辑
- 保持副作用顺序
- 使用 private 方法
- 保持异常传播路径

## 实用性验证

值得做的理由：
- 当前代码确实过长，影响维护
- 方法提取是安全的重构手段
- 为 ARCH-001（拆分上帝类）打基础
- 降低复杂度，减少 bug

## 执行计划

1. ✅ 深度思考完成
2. ⏳ 读取源代码，定位三个方法
3. ⏳ 分析逻辑结构和职责边界
4. ⏳ 提取子方法（Extract Method）
5. ⏳ 编译验证

## 核心决策

✅ **值得做**：符合实用主义，风险可控，改进明确

拆分策略：
- 识别职责边界（不是机械切割）
- 每个子方法只做一件事
- 消除特殊情况，减少 if/else
- 确保零破坏性
