name: ğŸ¤– Claude ä»£ç å¤„ç†

on:
  workflow_dispatch:
  push:
    paths:
      - 'prompt.md'
  schedule:
    - cron: '0 16 * * *'  # ä¸œå…«åŒºå‡Œæ™¨0ç‚¹ (UTC 16:00)

env:
  CARGO_TERM_COLOR: always

jobs:
  process-with-claude:
    name: ä½¿ç”¨ Claude å¤„ç†ä»£ç 
    runs-on: ubuntu-latest
    # å¹¶å‘æ§åˆ¶ï¼šæ–°ä»»åŠ¡è§¦å‘æ—¶å–æ¶ˆæ—§ä»»åŠ¡ï¼Œé¿å… git push å†²çª
    concurrency:
      group: claude-code-processing
      cancel-in-progress: true
    permissions:
      contents: write
      pull-requests: write

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿å¯ä»¥æ­£ç¡®æäº¤

      # æ–°å¢æ­¥éª¤: é‡å®šå‘è¿œç¨‹ä»“åº“åˆ°Gitea
      - name: é‡å®šå‘è¿œç¨‹ä»“åº“åˆ° Gitea
        run: |
          # æŸ¥çœ‹å½“å‰è¿œç¨‹ä»“åº“åœ°å€
          git remote -v
          # ä¿®æ”¹è¿œç¨‹ä»“åº“åœ°å€æŒ‡å‘Gitea[citation:1][citation:3][citation:6]
          git remote set-url origin https://${{ secrets.GITEA_USERNAME }}:${{ secrets.GITEA_TOKEN }}@git.httpx.online:0xMonkey/onescan.git
          # éªŒè¯ä¿®æ”¹ç»“æœ
          git remote -v

      # æ­¥éª¤2: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "kenyon"
          git config --global user.email "kenyon@noreply.localhost"
          git config --global commit.gpgsign false

      # æ­¥éª¤3: è®¾ç½®JDK 17
      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'liberica'

      # æ­¥éª¤4: è®¾ç½®Node.jsç¯å¢ƒ (Claude Codeä¾èµ–)
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v5
        with:
          node-version: '24'

      # æ­¥éª¤5: å…¨å±€å®‰è£…Claude Code
      - name: å…¨å±€å®‰è£… Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code@2.0.26

      # æ­¥éª¤6: é…ç½®Claude Codeç¯å¢ƒ
      - name: é…ç½® Claude Code ç¯å¢ƒ
        run: |
          cd ~ && rm -rf .claude && git clone --depth 1 https://github.com/kenyon-wong/.claude.git .claude

      # åœ¨ "Configure Claude Code environment" æ­¥éª¤ä¹‹åæ·»åŠ 
      - name: å®‰è£… Git æäº¤é’©å­
        run: |
          mkdir -p .git/hooks
          cp ~/.claude/hooks/prepare-commit-msg.sh .git/hooks/prepare-commit-msg
          chmod +x .git/hooks/prepare-commit-msg

      # æ­¥éª¤7: å®‰è£…Sequential Thinking MCPæœåŠ¡å™¨
      - name: å®‰è£… MCP æœåŠ¡å™¨
        run: |
          claude mcp add -s user -t http context7 https://mcp.context7.com/mcp
          claude mcp add -s user -t http grep https://mcp.grep.app
          claude mcp add -s user -t http deepwiki https://mcp.deepwiki.com/mcp
          claude mcp add-json "sequential-thinking" '{"command":"npx","args":["-y","@modelcontextprotocol/server-sequential-thinking"]}'

      # æ­¥éª¤7.5: æ¸…ç†å®Œæˆæ ‡è®°æ–‡ä»¶ï¼ˆå…è®¸é‡æ–°æ‰§è¡Œï¼‰
      - name: æ¸…ç†å®Œæˆæ ‡è®°æ–‡ä»¶
        run: |
          if [ -f .agent/completed ]; then
            rm .agent/completed
            echo "å·²åˆ é™¤ .agent/completed æ–‡ä»¶ï¼Œå…è®¸é‡æ–°æ‰§è¡Œä»»åŠ¡"
          else
            echo "æœªå‘ç° .agent/completed æ–‡ä»¶ï¼Œç»§ç»­æ‰§è¡Œ"
          fi

      # æ­¥éª¤8: è¯»å–å¤„ç†æŒ‡ä»¤å¹¶æ‰§è¡ŒClaude Code
      - name: ä½¿ç”¨ Claude Code å¤„ç†é¡¹ç›®
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_API }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          GIT_AUTHOR_NAME: kenyon
          GIT_AUTHOR_EMAIL: kenyon@noreply.localhost
          GIT_COMMITTER_NAME: kenyon
          GIT_COMMITTER_EMAIL: kenyon@noreply.localhost
          CLAUDE_CODE_DISABLE_COMMIT_SIGNATURES: 1  # å°è¯•æ€§æ·»åŠ ï¼ˆå¯èƒ½æ— æ•ˆï¼‰
        run: |
          while :; do
            # æ‰§è¡Œä¸»è¦å¤„ç†ä»»åŠ¡
            cat prompt.md | claude -p --dangerously-skip-permissions
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
            if [ -n "$(git status --porcelain)" ]; then
              echo "æ£€æµ‹åˆ°æœªæäº¤çš„å˜æ›´ï¼Œè°ƒç”¨Claudeè¿›è¡Œä»£ç å®¡æŸ¥å’Œæäº¤"
              claude -p "è¯·åˆ†æå½“å‰gitä»“åº“çŠ¶æ€ï¼Œå¦‚æœæœ‰å˜æ›´ï¼š1. æ˜¾ç¤ºå˜æ›´æ‘˜è¦;2. ç¡®è®¤æ˜¯å¦é€‚åˆæäº¤;3. å¦‚é€‚åˆï¼Œä½¿ç”¨è¯­ä¹‰åŒ–commitæ ¼å¼æäº¤;4. æ¨é€åˆ°å½“å‰åˆ†æ”¯" --dangerously-skip-permissions
            else
              echo "æ²¡æœ‰æ£€æµ‹åˆ°æœªæäº¤çš„å˜æ›´"
            fi
            
            # æ£€æŸ¥å®Œæˆæ ‡è®°æ–‡ä»¶
            if [ -f .agent/completed ]; then
              echo "æ£€æµ‹åˆ° .agent/completed æ–‡ä»¶ï¼Œä»»åŠ¡å·²å®Œæˆï¼Œé€€å‡ºå¾ªç¯"
              break
            fi
            
            # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¿‡å¿«é‡è¯•
            sleep 2
          done
          
          # å¾ªç¯ç»“æŸåï¼Œæ£€æŸ¥å¹¶æ¨é€æœ€ç»ˆçŠ¶æ€
          echo "æ£€æŸ¥æœ€ç»ˆçŠ¶æ€..."
          if [ -n "$(git status --porcelain)" ]; then
            echo "å‘ç°æœªæäº¤çš„å˜æ›´ï¼Œè¿›è¡Œæäº¤..."
            claude -p "è¯·åˆ†æå½“å‰gitä»“åº“çŠ¶æ€ï¼Œå¦‚æœæœ‰å˜æ›´ï¼š1. æ˜¾ç¤ºå˜æ›´æ‘˜è¦;2. ç¡®è®¤æ˜¯å¦é€‚åˆæäº¤;3. å¦‚é€‚åˆï¼Œä½¿ç”¨è¯­ä¹‰åŒ–commitæ ¼å¼æäº¤;4. æ¨é€åˆ°å½“å‰åˆ†æ”¯" --dangerously-skip-permissions
          fi
          
          # æœ€ç»ˆæ¨é€åˆ°è¿œç¨‹ä»“åº“
          echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push origin