name: ğŸ¤– Claude ä»£ç å¤„ç†

on:
  workflow_dispatch:
  push:
    paths:
      - 'prompt.md'
  schedule:
    - cron: '0 16 * * *'  # ä¸œå…«åŒºå‡Œæ™¨0ç‚¹ (UTC 16:00)

env:
  CARGO_TERM_COLOR: always

jobs:
  process-with-claude:
    name: ä½¿ç”¨ Claude å¤„ç†ä»£ç 
    runs-on: ubuntu-latest
    # å¹¶å‘æ§åˆ¶ï¼šæ–°ä»»åŠ¡è§¦å‘æ—¶å–æ¶ˆæ—§ä»»åŠ¡ï¼Œé¿å… git push å†²çª
    concurrency:
      group: claude-code-processing
      cancel-in-progress: true
    permissions:
      contents: write
      pull-requests: write

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿å¯ä»¥æ­£ç¡®æäº¤

      # æ–°å¢æ­¥éª¤: é‡å®šå‘è¿œç¨‹ä»“åº“åˆ°Gitea
      - name: é‡å®šå‘è¿œç¨‹ä»“åº“åˆ° Gitea
        run: |
          # æŸ¥çœ‹å½“å‰è¿œç¨‹ä»“åº“åœ°å€
          git remote -v
          # ä¿®æ”¹è¿œç¨‹ä»“åº“åœ°å€æŒ‡å‘Gitea[citation:1][citation:3][citation:6]
          git remote set-url origin https://${{ secrets.GITEA_USERNAME }}:${{ secrets.GITEA_TOKEN }}@git.httpx.online/0xMonkey/onescan.git
          # éªŒè¯ä¿®æ”¹ç»“æœ
          git remote -v

      # æ­¥éª¤2: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "kenyon"
          git config --global user.email "kenyon@noreply.localhost"
          git config --global commit.gpgsign false

      # æ­¥éª¤3: è®¾ç½®JDK 17
      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'liberica'

      # æ­¥éª¤4: è®¾ç½®Node.jsç¯å¢ƒ (Claude Codeä¾èµ–)
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v5
        with:
          node-version: '24'

      # æ­¥éª¤5: å…¨å±€å®‰è£…Claude Code
      - name: å…¨å±€å®‰è£… Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code@2.0.26

      # æ­¥éª¤6: é…ç½®Claude Codeç¯å¢ƒ
      - name: é…ç½® Claude Code ç¯å¢ƒ
        run: |
          cd ~ && rm -rf .claude && git clone --depth 1 https://github.com/kenyon-wong/.claude.git .claude

      # åœ¨ "Configure Claude Code environment" æ­¥éª¤ä¹‹åæ·»åŠ 
      - name: å®‰è£… Git æäº¤é’©å­
        run: |
          mkdir -p .git/hooks
          cp ~/.claude/hooks/prepare-commit-msg.sh .git/hooks/prepare-commit-msg
          chmod +x .git/hooks/prepare-commit-msg

      # æ­¥éª¤7: å®‰è£…Sequential Thinking MCPæœåŠ¡å™¨
      - name: å®‰è£… MCP æœåŠ¡å™¨
        run: |
          claude mcp add -s user -t http context7 https://mcp.context7.com/mcp
          claude mcp add -s user -t http grep https://mcp.grep.app
          claude mcp add -s user -t http deepwiki https://mcp.deepwiki.com/mcp
          claude mcp add-json "sequential-thinking" '{"command":"npx","args":["-y","@modelcontextprotocol/server-sequential-thinking"]}'

      # æ­¥éª¤7.5: æ¸…ç†å®Œæˆæ ‡è®°æ–‡ä»¶ï¼ˆå…è®¸é‡æ–°æ‰§è¡Œï¼‰
      - name: æ¸…ç†å®Œæˆæ ‡è®°æ–‡ä»¶
        run: |
          if [ -f .agent/completed ]; then
            rm .agent/completed
            echo "å·²åˆ é™¤ .agent/completed æ–‡ä»¶ï¼Œå…è®¸é‡æ–°æ‰§è¡Œä»»åŠ¡"
          else
            echo "æœªå‘ç° .agent/completed æ–‡ä»¶ï¼Œç»§ç»­æ‰§è¡Œ"
          fi

      # æ­¥éª¤8: è¯»å–å¤„ç†æŒ‡ä»¤å¹¶æ‰§è¡ŒClaude Code
      - name: ä½¿ç”¨ Claude Code å¤„ç†é¡¹ç›®
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_API }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          GIT_AUTHOR_NAME: kenyon
          GIT_AUTHOR_EMAIL: kenyon@noreply.localhost
          GIT_COMMITTER_NAME: kenyon
          GIT_COMMITTER_EMAIL: kenyon@noreply.localhost
          CLAUDE_CODE_DISABLE_COMMIT_SIGNATURES: 1  # å°è¯•æ€§æ·»åŠ ï¼ˆå¯èƒ½æ— æ•ˆï¼‰
        run: |
          chmod +x .github/agent-driver.sh
          .github/agent-driver.sh

      # æ­¥éª¤9: å¤„ç†æœªä¿å­˜çš„å˜æ›´å’Œæœªæ¨é€çš„æäº¤
      - name: å¤„ç†æœªä¿å­˜çš„å˜æ›´å’Œæœªæ¨é€çš„æäº¤
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_API }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          GIT_AUTHOR_NAME: kenyon
          GIT_AUTHOR_EMAIL: kenyon@noreply.localhost
          GIT_COMMITTER_NAME: kenyon
          GIT_COMMITTER_EMAIL: kenyon@noreply.localhost
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            echo "å‘ç°æœªä¿å­˜çš„å˜æ›´ï¼Œè°ƒç”¨ Claude Code ç”Ÿæˆæäº¤ä¿¡æ¯..."
            
            # æ˜¾ç¤ºå˜æ›´å†…å®¹
            echo "=== å˜æ›´æ–‡ä»¶åˆ—è¡¨ ==="
            git status --short
            echo ""
            echo "=== å˜æ›´è¯¦æƒ… ==="
            git diff --stat
            
            # ä½¿ç”¨ Claude Code ç”Ÿæˆæäº¤ä¿¡æ¯å¹¶æäº¤
            claude -p --dangerously-skip-permissions << 'EOF'
          è¯·æ ¹æ®å½“å‰çš„ git å˜æ›´ç”Ÿæˆä¸€ä¸ªç¬¦åˆ Conventional Commits è§„èŒƒçš„æäº¤ä¿¡æ¯ï¼Œå¹¶æ‰§è¡Œæäº¤ã€‚
          
          è¦æ±‚ï¼š
          1. ä½¿ç”¨ä¸­æ–‡ç¼–å†™æäº¤ä¿¡æ¯
          2. æ ¼å¼ï¼š<type>(<scope>): <subject>
          3. åŒ…å«è¯¦ç»†çš„æ­£æ–‡è¯´æ˜å˜æ›´å†…å®¹
          4. ä¸è¦æ·»åŠ  AI åä½œæ ‡è¯†æˆ–ç½²å
          
          æ‰§è¡Œæ­¥éª¤ï¼š
          1. è¿è¡Œ git status å’Œ git diff æŸ¥çœ‹å˜æ›´
          2. åˆ†æå˜æ›´å†…å®¹
          3. ç”Ÿæˆåˆé€‚çš„æäº¤ä¿¡æ¯
          4. æ‰§è¡Œ git add . && git commit -F <commit-msg-file>
          EOF
            
            echo "æäº¤å®Œæˆ"
          else
            echo "æ²¡æœ‰æœªä¿å­˜çš„å˜æ›´"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¨é€çš„æäº¤
          UNPUSHED_COMMITS=$(git log origin/$(git rev-parse --abbrev-ref HEAD)..HEAD --oneline 2>/dev/null || echo "")
          
          if [ -n "$UNPUSHED_COMMITS" ]; then
            echo "å‘ç°æœªæ¨é€çš„æäº¤ï¼Œå‡†å¤‡æ¨é€..."
            echo "=== æœªæ¨é€çš„æäº¤åˆ—è¡¨ ==="
            echo "$UNPUSHED_COMMITS"
            echo ""
            
            # æ¨é€åˆ°è¿œç¨‹ä»“åº“
            git push origin HEAD || {
              echo "æ¨é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†"
              exit 1
            }
            
            echo "æ¨é€æˆåŠŸ"
          else
            echo "æ²¡æœ‰æœªæ¨é€çš„æäº¤"
          fi
          
          echo "å˜æ›´å¤„ç†å®Œæˆ"
