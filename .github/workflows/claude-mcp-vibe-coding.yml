name: ğŸ¤– Claude ä»£ç å¤„ç†

on:
  workflow_dispatch:
  push:
    paths:
      - 'prompt.md'

env:
  CARGO_TERM_COLOR: always

jobs:
  process-with-claude:
    name: ä½¿ç”¨ Claude å¤„ç†ä»£ç 
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿å¯ä»¥æ­£ç¡®æäº¤

      # æ–°å¢æ­¥éª¤: é‡å®šå‘è¿œç¨‹ä»“åº“åˆ°Gitea
      - name: é‡å®šå‘è¿œç¨‹ä»“åº“åˆ° Gitea
        run: |
          # æŸ¥çœ‹å½“å‰è¿œç¨‹ä»“åº“åœ°å€
          git remote -v
          # ä¿®æ”¹è¿œç¨‹ä»“åº“åœ°å€æŒ‡å‘Gitea[citation:1][citation:3][citation:6]
          git remote set-url origin https://${{ secrets.GITEA_USERNAME }}:${{ secrets.GITEA_TOKEN }}@git.httpx.online/kenyon/codeql-scanner.git
          # éªŒè¯ä¿®æ”¹ç»“æœ
          git remote -v

      # æ­¥éª¤2: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "kenyon"
          git config --global user.email "kenyon@noreply.localhost"
          git config --global commit.gpgsign false

      # æ­¥éª¤3: è®¾ç½®JDK 17
      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'liberica'

      # æ­¥éª¤4: è®¾ç½®Node.jsç¯å¢ƒ (Claude Codeä¾èµ–)
      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v5
        with:
          node-version: '24'

      # æ­¥éª¤5: å…¨å±€å®‰è£…Claude Code
      - name: å…¨å±€å®‰è£… Claude Code
        run: |
          npm install -g @anthropic-ai/claude-code

      # æ­¥éª¤6: é…ç½®Claude Codeç¯å¢ƒ
      - name: é…ç½® Claude Code ç¯å¢ƒ
        run: |
          cd ~ && rm -rf .claude && git clone --depth 1 https://github.com/kenyon-wong/.claude.git .claude

      # åœ¨ "Configure Claude Code environment" æ­¥éª¤ä¹‹åæ·»åŠ 
      - name: å®‰è£… Git æäº¤é’©å­
        run: |
          mkdir -p .git/hooks
          cp ~/.claude/hooks/prepare-commit-msg.sh .git/hooks/prepare-commit-msg
          chmod +x .git/hooks/prepare-commit-msg

      # æ­¥éª¤7: å®‰è£…Sequential Thinking MCPæœåŠ¡å™¨
      - name: å®‰è£… MCP æœåŠ¡å™¨
        run: |
          claude mcp add -s user -t http context7 https://mcp.context7.com/mcp
          claude mcp add -s user -t http grep https://mcp.grep.app
          claude mcp add -s user -t http deepwiki https://mcp.deepwiki.com/mcp
          claude mcp add-json "sequential-thinking" '{"command":"npx","args":["-y","@modelcontextprotocol/server-sequential-thinking"]}'

      # æ­¥éª¤7.5: æ¸…ç†å®Œæˆæ ‡è®°æ–‡ä»¶ï¼ˆå…è®¸é‡æ–°æ‰§è¡Œï¼‰
      - name: æ¸…ç†å®Œæˆæ ‡è®°æ–‡ä»¶
        run: |
          if [ -f .agent/completed ]; then
            rm .agent/completed
            echo "å·²åˆ é™¤ .agent/completed æ–‡ä»¶ï¼Œå…è®¸é‡æ–°æ‰§è¡Œä»»åŠ¡"
          else
            echo "æœªå‘ç° .agent/completed æ–‡ä»¶ï¼Œç»§ç»­æ‰§è¡Œ"
          fi

      # æ­¥éª¤8: è¯»å–å¤„ç†æŒ‡ä»¤å¹¶æ‰§è¡ŒClaude Code
      - name: ä½¿ç”¨ Claude Code å¤„ç†é¡¹ç›®
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_API }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_API_KEY }}
          GIT_AUTHOR_NAME: kenyon
          GIT_AUTHOR_EMAIL: kenyon@noreply.localhost
          GIT_COMMITTER_NAME: kenyon
          GIT_COMMITTER_EMAIL: kenyon@noreply.localhost
          CLAUDE_CODE_DISABLE_COMMIT_SIGNATURES: 1  # å°è¯•æ€§æ·»åŠ ï¼ˆå¯èƒ½æ— æ•ˆï¼‰
        run: |
          while :; do
            cat prompt.md | claude -p --dangerously-skip-permissions
            # æ£€æŸ¥å®Œæˆæ ‡è®°æ–‡ä»¶ï¼Œå­˜åœ¨åˆ™é€€å‡ºå¾ªç¯
            if [ -f .agent/completed ]; then
              echo "æ£€æµ‹åˆ° .agent/completed æ–‡ä»¶ï¼Œä»»åŠ¡å·²å®Œæˆï¼Œé€€å‡ºå¾ªç¯"
              break
            fi
            # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¿‡å¿«é‡è¯•
            sleep 2 && git push origin
          done
          # å¾ªç¯ç»“æŸåï¼Œæ¨é€æ‰€æœ‰å˜æ›´åˆ°è¿œç¨‹ä»“åº“ï¼ˆGiteaï¼‰
          git push origin