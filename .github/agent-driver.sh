#!/usr/bin/env bash
set -euo pipefail

cd "$GITHUB_WORKSPACE"

# 1. ç¡®ä¿çŠ¶æ€ç³»ç»Ÿå°±ç»ªï¼ˆä½ å·²ç»æœ‰è¿™ä¸ªé€»è¾‘ï¼‰
if [ ! -f .agent/task_status.json ]; then
  echo "é¦–æ¬¡è¿è¡Œï¼Œåˆå§‹åŒ–çŠ¶æ€ç³»ç»Ÿ..."
  python .agent/task_status_manager.py init || echo "åˆå§‹åŒ–å®Œæˆ"
fi

# 2. æ¸…ç†æ—§çš„å®Œæˆæ ‡è®°ï¼ˆå…è®¸ç»§ç»­ï¼‰
rm -f .agent/completed

# 3. è®© Claude ä¸¥æ ¼æŒ‰ä½ çš„çŠ¶æ€ç³»ç»Ÿæ‰§è¡Œå½“å‰ä»»åŠ¡ï¼ˆå…³é”®ï¼ï¼‰
echo "äº¤ç»™ Claude æ‰§è¡Œå½“å‰å¾…å¤„ç†ä»»åŠ¡..."
claude -p --dangerously-skip-permissions << 'EOF'
$(cat prompt.md)

---

è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰§è¡Œæµç¨‹ï¼ˆè¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼‰ï¼š

1. ç«‹å³è¿è¡Œï¼špython .agent/task_status_manager.py status
   æ˜¾ç¤ºå½“å‰åº”è¯¥æ‰§è¡Œå“ªä¸ªä»»åŠ¡

2. å¦‚æœæœ‰ in_progress_tasksï¼Œç›´æ¥ç»§ç»­è¯¥ä»»åŠ¡
   å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨è°ƒç”¨ï¼špython .agent/task_status_manager.py next
   è·å–ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œä»»åŠ¡å¹¶æ ‡è®°ä¸º in_progress

3. ä¸“æ³¨äºå½“å‰è¿™ä¸€ä¸ªä»»åŠ¡ï¼ˆæˆ–å¯å®‰å…¨å¹¶è¡Œçš„å‡ ä¸ªå­ä»»åŠ¡ï¼‰
   - æ·±åº¦æ€è€ƒ â†’ æ‹†åˆ†å­ä»»åŠ¡ â†’ æ‰§è¡Œä¿®å¤ â†’ å†™æµ‹è¯• â†’ éªŒè¯
   - æ‰€æœ‰æ“ä½œå¿…é¡»ç¬¦åˆ .claude/skills/ ç›®å½•ä¸‹çš„æ‰€æœ‰ SKILL.md è§„èŒƒ

4. ä»»åŠ¡å®Œæˆåï¼Œå¿…é¡»æ‰§è¡Œï¼š
   python .agent/task_status_manager.py complete <TASK-ID> $(git rev-parse HEAD)

5. å¦‚æœæœ¬æ¬¡ä»»åŠ¡å¯¼è‡´äº†æ–°é—®é¢˜æˆ–æµ‹è¯•å¤±è´¥ï¼Œä¸»åŠ¨åˆ›å»ºæ–°çš„å­ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—

6. ä¸è¦ä¸€æ¬¡æ€§åšå¤ªå¤šï¼åªåšå½“å‰è¿›åº¦å…è®¸çš„ä»»åŠ¡
   åšå®Œåè®©ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®

7. ç»ä¸åœ¨æœ¬æ¬¡è¿è¡Œä¸­è¿›å…¥æ— é™å¾ªç¯
EOF

# 4. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¾…å¤„ç†ä»»åŠ¡
echo "æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€..."
NEXT_TASK=$(python .agent/task_status_manager.py next 2>/dev/null | grep -v "ä¸‹ä¸€ä¸ªä»»åŠ¡:" | grep -v "æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ" || echo "")

if [ -z "$NEXT_TASK" ] || [ "$NEXT_TASK" = "âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ!" ]; then
  echo "âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢è§¦å‘ä¸‹ä¸€è½®"
  # åˆ›å»ºå®Œæˆæ ‡è®°æ–‡ä»¶ï¼ˆä¸‹æ¬¡è¿è¡Œä¼šè¢«æ¸…ç†ï¼‰
  touch .agent/completed
  exit 0
fi

# 5. æäº¤å½“å‰è¿›åº¦ï¼ˆç¡®ä¿çŠ¶æ€æ–‡ä»¶å·²æ¨é€ï¼‰
if [ -n "$(git status --porcelain)" ]; then
  echo "æäº¤å½“å‰è¿›åº¦..."
  git add .
  git commit -m "chore: æ›´æ–°ä»»åŠ¡çŠ¶æ€" || true
  git push origin HEAD || echo "æ¨é€å¤±è´¥ï¼Œä¸‹ä¸€è½®ä¼šé‡è¯•"
fi

# 6. ã€è‡ªé©±åŠ¨æ ¸å¿ƒã€‘å®Œæˆæœ¬è½®åï¼Œè‡ªåŠ¨è§¦å‘ä¸‹ä¸€è½®
echo "ğŸ”„ è¿˜æœ‰å¾…å¤„ç†ä»»åŠ¡ ($NEXT_TASK)ï¼Œè§¦å‘ä¸‹ä¸€è½®..."
gh workflow run "Claude ä»£ç å¤„ç†" --ref $(git rev-parse --abbrev-ref HEAD)
